<!DOCTYPE html>
<html lang="es">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <title>Mantenimiento</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark px-3">
  <span class="navbar-brand">Tomza · Taller Cartago</span>
  <a href="/agenda/hoy" class="btn btn-outline-light btn-sm">Volver</a>
</nav>

<div class="container mt-4">

  <h3>Mantenimiento – <%= m.placa %></h3>

  <div class="alert alert-secondary">
    <b>Tipo:</b> <%= m.tipo %> |
    <b>Prioridad:</b> <%= m.prioridad %> |
    <b>Estado:</b> <%= m.estado %>
  </div>

  <!-- PLAN TALLER -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <h5>Plan (Taller)</h5>

      <% if (plan) { %>
        <div class="alert alert-info">
          <pre class="m-0"><%= plan.plan_texto %></pre>
        </div>
      <% } %>

      <% if (user.rol === 'TALLER' || user.rol === 'ADMIN') { %>
        <form method="POST" action="/mantenimientos/<%= m.id %>/plan">
          <textarea
            name="plan_texto"
            class="form-control"
            rows="4"
            placeholder="Qué se le piensa hacer a esta unidad..."
            required
          ><%= plan ? plan.plan_texto : '' %></textarea>

          <button class="btn btn-primary mt-2">Guardar plan</button>
        </form>
      <% } else { %>
        <div class="text-muted">Solo Taller o Admin puede editar el plan.</div>
      <% } %>
    </div>
  </div>

  <!-- EJECUCIÓN MECÁNICOS -->
  <div class="card shadow-sm">
    <div class="card-body">
      <h5>Ejecución (Mecánicos)</h5>

      <% if (ejecucion) { %>
        <div class="alert alert-success">
          <b>Realizado:</b>
          <pre class="m-0"><%= ejecucion.realizado_texto %></pre>

          <% if (ejecucion.pendientes_texto) { %>
            <hr>
            <b>Pendientes:</b>
            <pre class="m-0"><%= ejecucion.pendientes_texto %></pre>
          <% } %>
        </div>
      <% } %>

      <% if (user.rol === 'MECANICOS' || user.rol === 'ADMIN') { %>
        <form method="POST" action="/mantenimientos/<%= m.id %>/ejecucion">
          <label class="form-label">Qué se hizo</label>
          <textarea
            name="realizado_texto"
            class="form-control"
            rows="3"
            required
          ><%= ejecucion ? ejecucion.realizado_texto : '' %></textarea>

          <label class="form-label mt-2">Qué queda pendiente</label>
          <textarea
            name="pendientes_texto"
            class="form-control"
            rows="3"
          ><%= ejecucion ? (ejecucion.pendientes_texto || '') : '' %></textarea>

          <button class="btn btn-success mt-2">
            Guardar y cerrar mantenimiento
          </button>
        </form>
      <% } else { %>
        <div class="text-muted">Solo Mecánicos o Admin puede cerrar.</div>
      <% } %>
    </div>
  </div>

</div>

</body>
</html>
